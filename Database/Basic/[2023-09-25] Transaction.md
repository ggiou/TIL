# 🤍[2023-09-25]
## [1] Transaction (트랜잭션 기초)
### 정의
트랜잭션은 데이터베이스의 상태를 변환시키는 하나의 논리적 기능을 수행하기 위한 작업의 단위 <br>  
또는 한꺼번에 모두 수행되어야 할 일련의 연산들을 의미한다. = (데이터 베이스 상태를 변경시키기 위해 수행하는 작업 단위)
<br><b>상태를 변경시킨다 = SELECT, UPDATE, INSERT, DELETE와 같은 행동 들을 의미</b> 
<details>
<summary> 트랜잭션의 특징</summary>
<div><pre>
1. 트랜잭션은 데이터베이스 시스템에서 병행 제어 및 회복 작업 시 처리되는 작업의 논리적 단위
2. 사용자가 시스템에 대한 서비스 요구 시 시스템이 응답하기 위한 상태 변환과정의 작업 단위
3. 하나의 트랜잭션은 commit 되거나, rollback 된다.

<b>즉 상황에따라 여러개의 트랜잭션을 만들수 있다. -> 만들어진 트랜잭션들의 하나, 하나는 Commit(저장)되거나, RollBack(철회)될 수 있다.</b>
</pre></div>
</details>
<details>
<summary> 트랜잭션의 사용 이유</summary>
<div><pre>
<b>EX) ATM으로 계좌이체를 한다고 가정</b>

A 은행에서 출금하여 B은행으로 송금하려고 한다.
송금 중, 알 수 없는 오류가 발생하여 A은행 계좌에서 돈은 빠져나갔지만 B은행의 계좌에 입금되지 않았다.

↪️이와 같은 상황을 막기 위해 거래가 성공적으로 모두 끝나야 이를 완전한 거래로 승인하고, 
  거래 도중 뭔가 오류가 발생했을 때는 이 거래를 처음부터 없었던 거래로 완전히 되돌린다. 
    
↪️이렇게 거래의 안전성을 확보하는 방법이 트랜잭션이다.  
   데이터베이스에서는 테이블로부터 데이터를 읽어 온 후 다른 테이블에 데이터를 입력하거나 갱신, 삭제하는데 처리 도중 오류가 발생하면 Rollback 되고, 
   모든 처리 과정이 성공적으로 수행되었을 경우에 최종적으로 Commit 된다.
</pre></div>
</details>

### [2] 트랜잭션의 성질
<details>
<summary> 1. 원자성 (Atomicity)</summary>
<div><pre>
원자성이란, 트랜잭셩이 DB에 모두 반영되거나, 전혀 반영되지 않거나를 뜻한다 = All or Nothing 과 유사

- 트랜잭션의 연산은 데이터베이스에 모두 반영되든지 아니면 전혀 반영되지 않아야 한다.
- 트랜잭션 내의 모든 명령은 반드시 완벽히 수행되어야 하며, 모두가 완벽히 수행되지 않고 하나라도 오류가 발생하면 트랜잭션 전부가 취소되어야 한다.
</pre></div>
</details> 
<details>
<summary> 2. 일관성 (Consistency)</summary>
<div><pre>
일관성이란, 트랜잭션 작업 처리의 결과가 항상 일관되야 한다를 뜻한다. = 데이터 타입이 반환 후와 전이 항상 동일해야 함

- 트랜잭션이 그 실행을 성공적으로 완료하면 언제나 일관성 있는 데이터베이스 상태로 변환한다.
- 시스템이 가지고 있는 고정요소는 트랜잭션 수행 전과 트랜잭션 수행 완료 후의 상태가 같아야 한다.
</pre></div>
</details> 
<details>
<summary> 3. 독립성 (Isolation)</summary>
<div><pre>
독립성이란, 하나의 트랜잭션은 다른 트랜잭션 사이에 끼어들 수 없고, 독립적임을 의미한다. = 각각의 트랜잭션은 독립적이라 서로 간섭이 불가능함

- 둘 이상의 트랜잭션이 동시에 병행 실행되는 경우 어느 하나의 트랜잭션 실행중에 다른 트랜잭션의 연산이 끼어들 수 없다.
- 수행중인 트랜잭션은 완전히 완료될 때까지 다른 트랜잭션에서 수행 결과를 참조할 수 없다.
</pre></div>
</details> 
<details>
<summary> 4. 지속성 (Durablility)</summary>
<div><pre>
지속성(영속성)이란, 트랜잭션이 성공적으로 완료되면 영구적으로 결과에 반영되어야함을 의미한다. = 보통 commit이 된다면, 지속성은 충족됨 

- 성공적으로 완료된 트랜잭션의 결과는 시스템이 고장나더라도 영구적으로 반영되어야 한다.
</pre></div>
</details> 

### [3] 트랜잭션 연산 및 상태
![tran](https://github.com/ggiou/TIL/assets/110371892/7e10257c-457f-4b8b-b03c-a234571b7280)

#### [3-1] 연산
<details>
<summary><b>1. Commit 연산</b> = 변경된 데이터를 테이블에 영구적으로 반영하는 것</summary>
<div><pre>
: 하나의 트랜잭션이 성공적으로 끝나서 데이터베이스가 일관성있는 상태에 있음을 의미
 = 한개의 논리적 단위(트랜잭션)에 대한 작업이 성공적으로 끝났고, 데이터베이스가 다시 일관된 상태에 있을때, 이 트랜잭션이 행한 갱신 연산이 완료된 것을 트랜잭션 관리자에게 알려주는 연산

1) commit전에는 단지 메모리 Buffer에만 영향을 받았기 때문에, 데이터의 변경 이전 상태로 복구 가능 -> commit후에는 변경사항이 DB에 반영되며, 이전 데이터는 영원히 잃어버리게 됨.
2) 현재 사용자는 Select 문장으로 결과를 확인 가능
3) commit이전에, 다른 사용자는 현재 사용자가 수행한 명령의 결과를 볼 수 없다. → commit이후에, 모든 사용자가 결과를 확인 가능
4) commit이전에, 변경된 행은 잠금(Locking)이 설정되어서 다른 사용자가 변경할 수 없다. → commit이후에, 잠금(Locking)이 풀리고 다른 사용자들이 행을 조작함.
5) 어플리케이션의 정상적인 종료 or 이상 종료되어 DB접속이 단절되었을 때는 자동으로 Rollback.
</pre></div>
</details> 
<details>
<summary><b>2. RollBack 연산</b> = 테이블에 연산작용한 데이터에대해, Commit 이전의 상태나, save point 기준으로 변경사항 취소할 수 있도록 하는 것</summary>
<div><pre>
: 트랜잭션의  원자성이 깨질때, 즉 하나의 트랜잭션 처리가 비정상적으로 종료 되었을때 상태를 의미, RollBack이 이뤄진다면, 트랜잭션을 다시 실행하거나 부분적으로 변경된 결과를 취소할 수 있다.
= 하나의 트랜잭션 처리가 비정상적으로 종료되어 데이터베이스의 일관성을 깨뜨렸을 때, 이 트랜잭션의 일부가 정상적으로 처리되었더라도 트랜잭션의 원자성을 구현하기 위해 이 트랜잭션이 행한 모든 연산을 취소(Undo)하는 연산이다.
= Rollback시에는 해당 트랜잭션을 재시작하거나 폐기한다.

테이블 내 입력한 데이터나, 수정한 데이터, 삭제한 데이터에 대하여 Commit 이전에는 변경 사항을 취소할 수 있는데 이를 데이터베이스에서는 롤백(Rollback) 기능을 사용해 취소할 수 있다. 
롤백(Rollback)은 데이터 변경 사항이 취소되어 데이터의 이전 상태로 복구되며, 관련된 행에 대한 잠금(Locking)이 풀리고 다른 사용자들이 데이터 변경을 할 수 있게 됨을 의미한다.
</pre></div>
</details> 
<details>
<summary><b> 3. 저장점(SAVEPOINT)</b> = 트랜잭션이 진행되며, 원하는 롤백할 지점을 저장해 둔 것</summary>
<div><pre>
: SavePoint를 정의하면 롤백(Rollback)할 때 트랜잭션에 포함된 전체 작업을 롤백하는 것이 아니라 현 시점에서 Savepoint까지 트랜잭션의 일부만 롤백할 수 있다. 따라서 복잡한 대규모 트랜잭션에서 에러가 
  발생했을 때 Savepoint까지의 트랜잭션만 롤백하고 실패한 부분에 대해서만 다시 실행할 수 있다. (일부 툴에서는 지원이 안 될 수 있음) 복수의 Savepoint를 정의할 수 있으며, 동일한 이름으로 Savepoint를 정의했을 때는 나중에 정의한 저장점이 유효하다.
= 하나의 트랜잭션에 대해 여러개의 세이브 포인트를 만들고, rollback to 세이브포인트 문을 통해 큰 규모의 트랜잭션에서 특정한 그룹만 롤백할 수 있다.
</pre></div>
</details> 

#### [3-2] 상태
![trans_state](https://github.com/ggiou/TIL/assets/110371892/37e6f0e3-7ef5-45aa-b4dd-0329c7b2979f){:width="200" height ="150"}

- <b>활성(Active)</b> : 트랜잭션이 현재 실행 중인 상태 <br>
- <b>성공</b><br>
: - <b>부분 완료(Partially Committed)</b> : 트랜잭션의 마지막 연산까지 실행되고, Commit 연산이 실행되기 직전의 상태 <br>
: - <b>Commit</b> : 변경사항이 DB에 반영되고, 이전 데이터는 영원히 잃어 버림(저장) <br>
: - <b>완료(Committed</b>) : 트랜잭션이 성공적으로 종료되, Commit 연산을 실행한 후의 상태 <br>

- <b>오류</b> <br>
: - <b>실패(Failed)</b> : 트랜잭션에 오류가 발생하여 실행이 중단된 상태 <br>
: - <b>RollBack</b> : Rollback 이 이뤄진다면 트랜잭션을 다시 실행하거나 부분적으로 변경된 결과를 취소 가능(save point 기준으로 분기별 취소 가능) <br>
: - <b>철회(Aborted)</b> : 트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태 <br>
